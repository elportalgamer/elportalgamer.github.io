<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias â€” El Portal Gamer</title>
  <link rel="icon" type="image/png" href="mago.png" />
  <style>
    :root{--bg:#121212; --surface:#1f1f1f; --text:#f0f0f0; --muted:#b5b5b5; --brand:#ff4500; --radius:14px;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:5;background:#161616;border-bottom:1px solid #242424}
    .nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:#ff4500}
    .brand img{height:30px}
    .spacer{flex:1}
    input.search{width:300px;max-width:55vw;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff}

    main{max-width:1100px;margin:20px auto;padding:0 16px}
    h1{margin:0 0 10px}
    .divider{height:8px;border-radius:999px;background:linear-gradient(90deg,#ff6a00,#ff3b00,#ff6a00);margin:12px 0 18px}

    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:#1f1f1f;border:1px solid #262626;border-radius:var(--radius);overflow:hidden}
    .pad{padding:14px}
    .badge{font-size:.75rem;border:1px solid #333;padding:4px 8px;border-radius:999px;color:#ffcfbd;background:#1b0f0a}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#151515;color:#fff;text-decoration:none}
    .btn.brand{background:var(--brand);border-color:#ff5e1f;color:#111;font-weight:800}
    .btn.min{padding:8px 10px}

    .thumb{position:relative;width:100%;padding-top:60%;background:#0e0e0e;overflow:hidden;border-bottom:1px solid #262626}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

    article.read .hero{position:relative;width:100%;padding-top:42%;background:#0e0e0e;border-radius:14px;overflow:hidden;border:1px solid #262626;margin-bottom:12px}
    article.read .hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    article.read .content{line-height:1.65}
    article.read .content img{max-width:100%;height:auto;border-radius:10px}

    .muted{color:#b5b5b5}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><img src="mago.png" alt=""><strong>El Portal Gamer</strong></div>
    <a href="index.html" style="color:#eaeaea;text-decoration:none">Inicio</a>
    <div class="spacer"></div>
    <input id="q" class="search" placeholder="Buscar noticiaâ€¦">
  </div>
</header>

<main>
  <h1>Noticias</h1>
  <div class="divider"></div>

  <div id="list-view">
    <div class="grid" id="news-list"><div class="muted">Cargandoâ€¦</div></div>
    <div class="row" style="margin-top:14px">
      <button id="more" class="btn">MÃ¡s</button>
    </div>
  </div>

  <article id="read-view" class="read" style="display:none">
    <div class="hero"><img id="read-img" alt="" referrerpolicy="no-referrer"></div>
    <h2 id="read-title"></h2>
    <p class="muted" id="read-meta"></p>
    <div class="row" style="margin:10px 0 14px">
      <a id="read-open" class="btn brand min" target="_blank" rel="noopener">ðŸ“° Abrir en pestaÃ±a</a>
      <button id="read-share" class="btn min">ðŸ”— Compartir</button>
      <a class="btn min" href="news.html">â¬… Volver</a>
    </div>
    <div id="read-content" class="content"></div>
  </article>
</main>

<script>
/* Utils */
const $ = (s,p=document)=>p.querySelector(s);
const $$= (s,p=document)=>[...p.querySelectorAll(s)];
const truncate=(t,n)=> (t||"").length>n ? t.slice(0,n).replace(/\s+\S*$/,'')+"â€¦" : t;

function hq(url, size=1600){
  if(!url) return "";
  let u = url
    .replace(/\/s\d+(-c)?\//, `/s${size}/`)
    .replace(/=s\d+(-c)?/, `=s${size}`)
    .replace(/\/w\d+-h\d+(-c)?\//, `/s${size}/`);
  if (/blogger\.googleusercontent\.com/.test(u) && !/[?&]imgmax=/.test(u)) {
    u += (u.includes("?")?"&":"?")+`imgmax=${size}`;
  }
  return u;
}
function ensureHiRes(img, original){
  if (img.naturalWidth && img.naturalWidth < 600) {
    const better = hq(original || img.currentSrc || img.src, 1600);
    if (better !== img.src) {
      img.src = better;
      img.srcset = `${hq(original,400)} 400w, ${hq(original,800)} 800w, ${hq(original,1200)} 1200w, ${hq(original,1600)} 1600w`;
    }
  }
}
function timeAgo(iso){
  const d = new Date(iso); const diff = (Date.now() - d.getTime())/1000;
  const units = [[31536000,'a'],[2592000,'m'],[604800,'sem'],[86400,'d'],[3600,'h'],[60,'min']];
  for(const [s,n] of units){ if(diff>=s) return `${Math.floor(diff/s)} ${n}`; }
  return 'ahora';
}
function shareIt(url, title){
  const absolute = new URL(url, location.href).toString();
  if (navigator.share) navigator.share({title, url:absolute}).catch(()=>{});
  else { navigator.clipboard?.writeText(absolute); alert("Enlace copiado"); }
}

/* Data */
const PAGE_SIZE = 9;
let page = 0, cache = [];

async function fetchJson(u){ const r=await fetch(u,{cache:'no-store'}); const t=await r.text(); try{return JSON.parse(t);}catch{return{}}; }

function renderList(items, append=false){
  const grid = $("#news-list");
  if (!append) grid.innerHTML = "";
  for (const n of items){
    const card = document.createElement('article');
    card.className = "card";
    const hi = hq(n.image, 1600);
    card.innerHTML = `
      <a class="thumb" href="news.html?id=${encodeURIComponent(n.id)}">
        <img loading="lazy" decoding="async" referrerpolicy="no-referrer"
             src="${hi}"
             srcset="${hq(n.image,400)} 400w, ${hq(n.image,800)} 800w, ${hq(n.image,1200)} 1200w, ${hq(n.image,1600)} 1600w"
             sizes="(min-width: 900px) 33vw, 90vw" alt="">
      </a>
      <div class="pad">
        <div class="row" style="margin-bottom:8px"><span class="badge">Noticia</span><span class="muted">${new Date(n.date).toLocaleDateString()}</span><span class="muted">â€¢ ${timeAgo(n.date)}</span></div>
        <h3 style="margin:6px 0 8px">${n.title}</h3>
        <p class="muted" style="margin:0 0 10px">${truncate(n.summary||"", 220)}</p>
        <div class="row">
          <a class="btn brand min" href="news.html?id=${encodeURIComponent(n.id)}">ðŸ“° Leer</a>
          <button class="btn min" onclick="shareIt('news.html?id=${encodeURIComponent(n.id)}','${n.title.replace(/"/g,'&quot;')}')">ðŸ”— Compartir</button>
        </div>
      </div>`;
    const img = card.querySelector('img');
    img.addEventListener('load', ()=>ensureHiRes(img, n.image));
    img.addEventListener('error', ()=>{ img.src = hq(n.image,1600); });
    grid.appendChild(card);
  }
}

async function loadPage(){
  if (!cache.length){
    // Cargamos news.json (ya curado) como fuente principal
    const data = await fetchJson('news.json');
    cache = Array.isArray(data) ? data : [];
  }
  const slice = cache.slice(page*PAGE_SIZE, (page+1)*PAGE_SIZE);
  renderList(slice, page>0);
  page++;
  $("#more").style.display = (page*PAGE_SIZE < cache.length) ? "" : "none";
}

function showRead(id){
  const item = cache.find(x=> String(x.id)===String(id));
  if (!item){ location.href = 'news.html'; return; }
  $("#list-view").style.display = "none";
  $("#read-view").style.display = "";
  $("#read-title").textContent = item.title;
  $("#read-meta").textContent  = new Date(item.date).toLocaleString();
  $("#read-open").href = new URL(`news.html?id=${encodeURIComponent(item.id)}`, location.href);
  $("#read-share").onclick = ()=>shareIt(`news.html?id=${encodeURIComponent(item.id)}`, item.title);
  const img = $("#read-img");
  img.src = hq(item.image, 1600);
  img.srcset = `${hq(item.image,400)} 400w, ${hq(item.image,800)} 800w, ${hq(item.image,1200)} 1200w, ${hq(item.image,1600)} 1600w`;
  img.addEventListener('load', ()=>ensureHiRes(img, item.image));
  img.addEventListener('error', ()=>{ img.src = hq(item.image,1600); });

  // cuerpo
  $("#read-content").innerHTML = item.contentHtml || `<p>${item.summary||""}</p><p><a href="${item.url}" target="_blank" rel="noopener">Abrir en Blogger</a></p>`;
}

(async function init(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  await loadPage();
  if (id) showRead(id);

  // buscador simple
  $("#q").addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    const filtered = cache.filter(n => (n.title+" "+(n.summary||"")).toLowerCase().includes(q));
    page=0;
    $("#news-list").innerHTML="";
    renderList(filtered.slice(0,PAGE_SIZE));
    $("#more").style.display = (filtered.length > PAGE_SIZE) ? "" : "none";
  });
  $("#more").addEventListener('click', loadPage);
})();
</script>
</body>
</html>
