<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias â€” El Portal Gamer</title>
  <link rel="icon" type="image/png" href="mago.png" />
  <meta name="description" content="Noticias de videojuegos curadas por El Portal Gamer." />
  <style>
    :root{ --bg:#121212; --surface:#1f1f1f; --text:#f0f0f0; --muted:#b5b5b5; --brand:#ff4500; --radius:14px; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:5; background:#161616; border-bottom:1px solid #242424; }
    .nav{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:12px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:1.25rem; color:var(--brand)}
    .brand img{height:34px;width:auto;border-radius:6px}
    .nav a{color:#eaeaea;text-decoration:none;opacity:.9; padding:6px 8px; border-radius:10px}
    .nav a:hover{opacity:1; background:#1b1b1b}
    .spacer{flex:1}
    .search{width:320px; max-width:55vw; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#0f0f0f; color:#fff}
    main{max-width:1100px; margin:20px auto; padding:0 16px}
    section{margin:24px 0}
    h1{margin:0 0 12px; font-size:1.5rem}

    .grid{display:grid; gap:16px}
    .grid.cols-3{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:var(--surface); border:1px solid #262626; border-radius:var(--radius); overflow:hidden}
    .card.pad{padding:14px}
    .title{font-weight:800; margin:8px 0 10px}
    .desc{color:#cfcfcf; font-size:.98rem; line-height:1.55}
    .muted{color:#bdbdbd; font-size:.9rem}
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#151515; color:#fff; text-decoration:none; }
    .btn.brand{background:var(--brand); border-color:#ff5e1f; color:#111; font-weight:800}

    .news-thumb{position:relative; width:100%; aspect-ratio:16/9; background:#0e0e0e; border-radius:12px; overflow:hidden; border:1px solid #262626; margin-bottom:12px}
    .news-thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block}

    .news-card{display:flex; flex-direction:column}
    .news-footer{margin-top:auto; display:flex; gap:10px; justify-content:center; padding-top:12px}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><img src="mago.png" alt="Logo" />El Portal Gamer</div>
    <a href="index.html#ultimo">Inicio</a>
    <a href="index.html#news">Noticias</a>
    <a href="index.html#mini">ReseÃ±as</a>
    <a href="index.html#series">Series</a>
    <a href="videos.html">Videos</a>
    <div class="spacer"></div>
    <input id="q" class="search" type="search" placeholder="Buscar noticiaâ€¦" />
  </div>
</header>

<main>
  <section>
    <h1>Noticias</h1>
    <div class="grid cols-3" id="list"></div>
    <div id="detail" class="card pad" style="display:none"></div>
  </section>
</main>

<script>
const BLOGGER_FEED_HTTPS = "https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=30&orderby=published";
const JINA = "https://r.jina.ai";
const ALLO = "https://api.allorigins.win/raw";
const DEFAULT_NEWS_IMAGE = "og.jpg";

const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => [...p.querySelectorAll(s)];
const truncate = (str, n) => (str||"").length>n ? str.slice(0,n).replace(/\s+\S*$/,'')+"â€¦" : str;

/* Anti-pixelado ROBUSTO (igual que en index) */
function upsizeBloggerImage(url, size = 1200){
  if(!url) return "";
  let u = url;
  u = u.replace(/\/s\d+(?:-[a-z])?\/?/gi, "/");
  u = u.replace(/\/w\d+-h\d+(?:-c)?\/?/gi, "/");
  u = u.replace(/-w\d+-h\d+(?:-c)?/gi, "");
  u = u.replace(/=s\d+(?:-c)?/gi, "");
  u = u.replace(/\/([^\/?#]+)(\?|#|$)/, `/s${size}/$1$2`);
  return u;
}
function imgTagHD(src, alt=""){
  const s400  = upsizeBloggerImage(src, 400);
  const s800  = upsizeBloggerImage(src, 800);
  const s1200 = upsizeBloggerImage(src, 1200);
  return `
    <img loading="lazy" decoding="async"
         src="${s800}"
         srcset="${s400} 400w, ${s800} 800w, ${s1200} 1200w"
         sizes="(min-width: 1200px) 340px, (min-width: 900px) 33vw, 90vw"
         alt="${(alt||'').replace(/"/g,'&quot;')}">`;
}

function extractImgFromHtml(html){
  const m = (html||"").match(/<img[^>]+src=["']([^"']+)["']/i);
  return m ? m[1] : "";
}
function timeAgo(iso){
  const d = new Date(iso); const diff = (Date.now() - d.getTime())/1000;
  const units = [[31536000,'a'],[2592000,'m'],[604800,'sem'],[86400,'d'],[3600,'h'],[60,'min']];
  for(const [s,n] of units){ if(diff>=s) return `${Math.floor(diff/s)} ${n}`; }
  return 'ahora';
}
function parseBloggerJson(data){
  const entries = data?.feed?.entry || [];
  return entries.map(e => {
    const rawHtml = e.summary?.$t || e.content?.$t || "";
    const textOnly = rawHtml.replace(/<[^>]+>/g, " ").replace(/\s+/g,' ').trim();
    const titleRaw = (e.title?.$t || "").trim();
    const title = titleRaw || (textOnly ? textOnly.split(/\s+/).slice(0,12).join(" ") + "â€¦" : "Sin tÃ­tulo");
    const link  = (e.link || []).find(l=>l.rel==='alternate')?.href || '#';
    const date  = e.published?.$t || e.updated?.$t || new Date().toISOString();
    const idStr = (e.id?.$t || "").split("post-").pop() || "";
    const thumbRaw = e['media$thumbnail']?.url || extractImgFromHtml(rawHtml) || DEFAULT_NEWS_IMAGE;
    const image = upsizeBloggerImage(thumbRaw, 1200);
    return { id:idStr, title, url: link, date, summary: textOnly, image };
  });
}

function shareNews(n){
  const url = `${location.origin}/news.html?id=${encodeURIComponent(n.id)}`;
  const text = `${n.title} â€” El Portal Gamer`;
  if (navigator.share){
    navigator.share({title:n.title, text, url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(url).then(()=>alert("Enlace copiado âœ”"));
  }
}

function renderList(items){
  $("#detail").style.display = "none";
  const list = $("#list"); list.style.display="grid"; list.innerHTML = "";
  items.forEach(n=>{
    const card = document.createElement('article');
    card.className = "card pad news-card";
    const img = imgTagHD(n.image||DEFAULT_NEWS_IMAGE, n.title);
    card.innerHTML = `
      <a class="news-thumb" href="news.html?id=${encodeURIComponent(n.id)}">${img}</a>
      <div class="muted">${new Date(n.date).toLocaleDateString()} â€¢ ${timeAgo(n.date)}</div>
      <div class="title">${n.title}</div>
      <p class="desc">${truncate(n.summary, 240)}</p>
      <div class="news-footer">
        <a class="btn brand" href="news.html?id=${encodeURIComponent(n.id)}">ðŸ“° Leer</a>
        <button class="btn" onclick='shareNews(${JSON.stringify(n)})'>ðŸ”— Compartir</button>
      </div>
    `;
    list.appendChild(card);
  });
}

function renderDetail(n){
  $("#list").style.display = "none";
  const box = $("#detail"); box.style.display = "block";
  const img = imgTagHD(n.image||DEFAULT_NEWS_IMAGE, n.title);
  box.innerHTML = `
    <div class="muted">${new Date(n.date).toLocaleDateString()} â€¢ ${timeAgo(n.date)}</div>
    <h2 style="margin:.2rem 0 0">${n.title}</h2>
    <div class="news-thumb" style="margin-top:10px">${img}</div>
    <p class="desc" style="margin-top:10px">${(n.summary||'').replace(/&nbsp;/g,' ')}</p>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
      <button class="btn" onclick='shareNews(${JSON.stringify(n)})'>ðŸ”— Compartir</button>
      <a class="btn" href="index.html#news">âŸµ Volver</a>
      <a class="btn brand" href="${n.url}" target="_blank" rel="noopener">Abrir en Blogger</a>
    </div>
  `;
}

// JSON con fallback local
async function fetchJson(url){
  const r = await fetch(url, {cache:'no-store'});
  const txt = await r.text();
  try{ return JSON.parse(txt); }catch{ return {}; }
}
async function getBloggerData(){
  const urls = [
    `${JINA}/http://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=30&orderby=published`,
    `${JINA}/https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=30&orderby=published`,
    `${ALLO}?url=${encodeURIComponent(BLOGGER_FEED_HTTPS)}`,
    BLOGGER_FEED_HTTPS
  ];
  for (const u of urls){
    try{
      const data = await fetchJson(u);
      if (data?.feed?.entry?.length) return data;
    }catch{}
  }
  throw new Error("No feed");
}

async function init(){
  const params = new URLSearchParams(location.search);
  const wantId = params.get("id");
  let items = [];
  try{
    const data = await getBloggerData();
    items = parseBloggerJson(data);
  }catch(e){
    try{
      const local = await (await fetch('/news.json', {cache:'no-store'})).json();
      items = (local||[]).map(n=>({
        ...n,
        id: n.id || (n.url?.split("post-").pop() || n.url || Math.random().toString(36).slice(2)),
        image: upsizeBloggerImage(n.image, 1200)
      }));
    }catch{}
  }

  if (!items.length){
    $("#list").innerHTML = `<div class="muted">No hay noticias para mostrar.</div>`;
    return;
  }

  if (wantId){
    const hit = items.find(x=> String(x.id) === String(wantId));
    if (hit) renderDetail(hit); else renderList(items);
  } else {
    renderList(items);
  }

  // Buscador
  $("#q").addEventListener("input", e=>{
    const q = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    for (const card of $$(".news-card")){
      const hay = (card.textContent||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(q);
      card.style.display = (!q || hay) ? "" : "none";
    }
  });
}

init();
</script>
</body>
</html>
