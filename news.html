<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias — El Portal Gamer</title>
  <link rel="canonical" href="https://www.elportalgamer.com/news.html" />
  <meta name="description" content="Noticias y novedades de El Portal Gamer: reseñas, retro y rarezas." />

  <style>
    :root{ --bg:#121212; --surface:#1f1f1f; --text:#f0f0f0; --muted:#b5b5b5; --brand:#ff4500; --radius:14px; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:5; background:#161616; border-bottom:1px solid #242424; }
    .nav{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:12px 16px }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:1.25rem; color:var(--brand) }
    .brand img{ height:34px; border-radius:6px }
    .nav a{ color:#eaeaea; text-decoration:none; opacity:.9; padding:6px 8px; border-radius:10px }
    .nav a:hover{ opacity:1; background:#1b1b1b }
    .spacer{ flex:1 }

    main{ max-width:1100px; margin:20px auto; padding:0 16px }
    h1{ margin:0 0 12px; font-size:1.4rem }
    .layout{ display:grid; grid-template-columns:360px 1fr; gap:20px }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr } }

    .list{ display:flex; flex-direction:column; gap:12px }
    .item{ display:flex; gap:10px; border:1px solid #262626; border-radius:var(--radius); padding:8px; background:var(--surface); text-decoration:none; color:inherit }
    .item:hover{ background:#222 }
    .item img{ width:84px; height:84px; object-fit:cover; border-radius:10px; background:#0f0f0f }
    .item h4{ margin:0 0 4px; font-size:.98rem; line-height:1.2 }
    .item time{ color:var(--muted); font-size:.85rem; }
    .item p{ margin:4px 0 0; color:#cfcfcf; font-size:.9rem; line-height:1.35; max-height:2.6em; overflow:hidden }

    .viewer{ border:1px solid #262626; border-radius:var(--radius); overflow:hidden; background:#000; min-height:60vh }
    .viewer header{ display:flex; align-items:center; gap:10px; padding:10px 12px; background:#151515; border-bottom:1px solid #262626; position:sticky; top:0; z-index:2 }
    .viewer header .title{ font-weight:700; font-size:1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .viewer header .actions{ margin-left:auto; display:flex; gap:8px }
    .viewer header .btn{ border:1px solid #333; background:#0e0e0e; color:#fff; border-radius:10px; padding:8px 10px; text-decoration:none; font-size:.9rem }
    iframe{ width:100%; height:80vh; border:0; display:block; }
    .muted{ color:var(--muted) }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><img src="mago.png" alt="Logo" />El Portal Gamer</div>
    <a href="/">Inicio</a>
    <a href="/#news">Noticias</a>
    <div class="spacer"></div>
  </div>
</header>

<main>
  <h1>Noticias</h1>
  <div class="layout">
    <!-- LISTA -->
    <section aria-label="Listado de noticias">
      <div id="news-list" class="list">
        <div class="muted">Cargando noticias…</div>
      </div>
    </section>

    <!-- DETALLE -->
    <section class="viewer" aria-label="Detalle de noticia">
      <header>
        <div id="viewer-title" class="title">Seleccioná una noticia…</div>
        <div class="actions">
          <a id="open-external" class="btn" target="_blank" rel="noopener">Abrir en Blogger</a>
          <a id="copy-link" class="btn" href="#">Copiar enlace</a>
        </div>
      </header>
      <iframe id="news-frame" title="Detalle de noticia" loading="lazy"></iframe>
    </section>
  </div>
</main>

<script>
/* ====== Config ====== */
/* Dos blogs (no se borra el que ya funcionaba) */
const FEEDS = [
  "https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=20&orderby=published",
  "https://elblogdelportalgamer.blogspot.com/feeds/posts/summary?alt=json&max-results=20&orderby=published"
];
const FALLBACK_JSON = "/news.json";
const JINA="https://r.jina.ai";
const ALLO="https://api.allorigins.win/raw";

/* ====== Utils ====== */
const $ = (s,p=document)=>p.querySelector(s);
function fmtDate(iso){
  try{ return new Date(iso).toLocaleDateString('es-PE',{ year:'numeric', month:'short', day:'2-digit' }); }
  catch{ return ""; }
}
function truncate(str,n){ return (str||"").length>n ? (str.slice(0,n).replace(/\s+\S*$/,'')+"…") : (str||""); }
function stripHtml(html){ return (html||"").replace(/<[^>]+>/g," ").replace(/\s+/g,' ').trim(); }
function firstImg(html){
  const m = /<img[^>]+src=["']([^"']+)["']/i.exec(html || "");
  return m ? m[1] : "";
}
function bloggerToOriginal(u){ if(!u) return ''; return u.replace(/\/s\d+[^/]*\//,'/s0/').replace(/=s\d+[^&?]*/,'=s0');}

/* ====== Fetch feeds con proxies ====== */
async function fetchJson(url){
  const r = await fetch(url,{cache:'no-store'});
  const t = await r.text();
  try { return JSON.parse(t); } catch { return {}; }
}
async function fetchFeedViaProxies(feedUrl){
  const httpUrl = feedUrl.replace("https://","http://");
  const tries = [
    `${JINA}/${httpUrl}`,
    `${JINA}/${feedUrl}`,
    `${ALLO}?url=${encodeURIComponent(feedUrl)}`,
    feedUrl
  ];
  for(const u of tries){
    try{
      const d = await fetchJson(u);
      if(d?.feed?.entry?.length) return d;
    }catch{}
  }
  return null;
}

/* ====== Parse Blogger ====== */
function parseBlogger(data){
  const entries = data?.feed?.entry || [];
  return entries.map(e=>{
    const raw = e.summary?.$t || e.content?.$t || "";
    const text = stripHtml(raw);
    const title = (e.title?.$t || "").trim() || (text ? text.split(/\s+/).slice(0,12).join(" ")+"…" : "Sin título");
    const link = (e.link||[]).find(l=>l.rel==='alternate')?.href || '';
    const date = e.published?.$t || e.updated?.$t || new Date().toISOString();
    const id = (e.id?.$t||"").split("post-").pop();
    const thumb0 = e['media$thumbnail']?.url || firstImg(raw) || "";
    return { id, title, url: link, date, excerpt: text, thumb: bloggerToOriginal(thumb0) };
  });
}

/* ====== Merge, dedupe, sort ====== */
function dedupeSort(items){
  const seen=new Set(), out=[];
  for(const it of items){
    const key = it.url || it.id || (it.title+"|"+it.date);
    if(seen.has(key)) continue;
    seen.add(key); out.push(it);
  }
  out.sort((a,b)=> new Date(b.date) - new Date(a.date));
  return out;
}

/* ====== Render ====== */
function renderList(items){
  const list = $("#news-list");
  list.innerHTML = "";
  items.forEach(n=>{
    const a = document.createElement("a");
    a.className = "item";
    a.href = makeHref(n);
    a.dataset.url = n.url;
    a.dataset.title = n.title;
    a.innerHTML = `
      <img loading="lazy" decoding="async" src="${n.thumb || 'og.jpg'}" alt="">
      <div>
        <h4>${n.title}</h4>
        <time datetime="${n.date}">${fmtDate(n.date)}</time>
        <p>${truncate(n.excerpt, 120)}</p>
      </div>
    `;
    a.addEventListener("click", (e)=>{ e.preventDefault(); openInViewer(n); history.replaceState(null,"",a.href); });
    list.appendChild(a);
  });
}

function makeHref(n){
  const base = new URL(location.origin + location.pathname);
  if(n.id) base.searchParams.set('id', n.id);
  if(n.url) base.searchParams.set('u', n.url);
  return base.toString();
}

function openInViewer(n){
  $("#viewer-title").textContent = n.title || "Noticia";
  $("#open-external").href = n.url || "#";
  $("#news-frame").src = n.url || "";
}

/* ====== Init ====== */
async function loadAll(){
  try{
    const datas = (await Promise.all(FEEDS.map(f=>fetchFeedViaProxies(f)))).filter(Boolean);
    if(!datas.length) throw new Error("sin feeds");
    const merged = dedupeSort(datas.flatMap(parseBlogger));
    renderList(merged);

    // Cargar por URL (?u=... | ?id=...)
    const params = new URLSearchParams(location.search);
    const u = params.get("u");
    let current = null;

    if(u){
      current = merged.find(x=>x.url===u) || { title:"Noticia", url:u, date:new Date().toISOString() };
    }else if(params.get("id")){
      const id = params.get("id");
      current = merged.find(x=>x.id===id) || merged[0];
    }else{
      current = merged[0];
    }
    if(current) openInViewer(current);

    // Copiar enlace
    $("#copy-link").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        await navigator.clipboard.writeText(location.href);
        $("#copy-link").textContent = "Enlace copiado ✅";
        setTimeout(()=> $("#copy-link").textContent = "Copiar enlace", 1500);
      }catch{}
    });

  }catch(e){
    // Fallback a /news.json
    try{
      const r = await fetch(FALLBACK_JSON, {cache:"no-store"});
      const items = await r.json();
      const norm = (Array.isArray(items)?items:items.items||[]).map(n=>({
        id: n.id || "",
        title: n.title || "Sin título",
        url: n.url || "#",
        date: n.date || new Date().toISOString(),
        excerpt: n.excerpt || n.summary || "",
        thumb: n.thumb || n.image || ""
      }));
      const merged = dedupeSort(norm);
      if(!merged.length) throw new Error("fallback vacío");
      renderList(merged);
      openInViewer(merged[0]);
    }catch{
      $("#news-list").innerHTML = `<div class="muted">No se pudieron cargar las noticias.</div>`;
    }
  }
}

loadAll();
</script>
</body>
</html>
