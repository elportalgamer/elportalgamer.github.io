<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias â€” El Portal Gamer</title>
  <link rel="icon" type="image/png" href="mago.png" />
  <meta name="description" content="Noticias de videojuegos â€” El Portal Gamer" />
  <style>
    :root{ --bg:#121212; --surface:#1f1f1f; --text:#f0f0f0; --muted:#b5b5b5; --brand:#ff4500; --radius:14px; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:5; background:#161616; border-bottom:1px solid #242424; }
    .nav{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:12px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:1.25rem; color:var(--brand)}
    .brand img{height:34px;width:auto;border-radius:6px}
    .nav a{color:#eaeaea;text-decoration:none;opacity:.9; padding:6px 8px; border-radius:10px}
    .nav a:hover{opacity:1; background:#1b1b1b}
    .spacer{flex:1}
    .search{width:320px; max-width:55vw; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#0f0f0f; color:#fff}

    main{max-width:1100px; margin:20px auto; padding:0 16px}
    h1{margin:0 0 4px; font-size:1.6rem}
    .muted{color:var(--muted)}
    .divider{height:8px; border-radius:999px; background:linear-gradient(90deg,#ff6a00,#ff3b00,#ff6a00); margin:18px 0}
    .grid{display:grid; gap:16px}
    .grid.cols-3{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:var(--surface); border:1px solid #262626; border-radius:var(--radius); overflow:hidden}
    .pad{padding:14px}

    .article-hero{width:100%; max-height:520px; object-fit:cover; border-radius:12px; border:1px solid #262626}
    .article{display:grid; gap:12px}
    .news-thumb{position:relative; width:100%; aspect-ratio:1/1; overflow:hidden; border-bottom:1px solid #262626}
    .news-thumb img{width:100%; height:100%; object-fit:cover; display:block}

    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#151515; color:#fff; text-decoration:none; }
    .btn.brand{background:var(--brand); border-color:#ff5e1f; color:#111; font-weight:800}
    .actions{display:flex; gap:10px; margin-top:6px; flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><img src="mago.png" alt="Logo" />El Portal Gamer</div>
    <a href="index.html#news">Volver</a>
    <div class="spacer"></div>
    <input id="q" class="search" type="search" placeholder="Buscar noticiaâ€¦" />
  </div>
</header>

<main>
  <h1>Noticias</h1>
  <div class="divider" aria-hidden="true"></div>

  <div id="view"></div>
</main>

<script>
const $ = (s, p=document)=>p.querySelector(s);
const JINA = "https://r.jina.ai";
const ALLO = "https://api.allorigins.win/raw";
const FEED = "https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=9&orderby=published";
const DEFAULT_NEWS_IMAGE = "og.jpg";

/* Forzar HD en imÃ¡genes de Blogger */
function upsizeBloggerImage(url, size=1200){
  if(!url) return "";
  return url.replace(/\/s\d+(-c)?\//, `/s${size}/`)
            .replace(/=s\d+(-c)?/, `=s${size}`)
            .replace(/\/w\d+-h\d+(-c)?\//, `/w${size}-h${size}-c/`)
            .replace(/\/s72(-c)?\//, `/s${size}/`);
}
function imgTagHD(src, alt=""){
  const s400 = upsizeBloggerImage(src, 400);
  const s800 = upsizeBloggerImage(src, 800);
  const s1200 = upsizeBloggerImage(src, 1200);
  return `<img loading="lazy" decoding="async" class="article-hero"
          src="${s800}" srcset="${s400} 400w, ${s800} 800w, ${s1200} 1200w"
          sizes="(min-width: 900px) 100vw, 100vw" alt="${alt.replace(/"/g,'&quot;')}">`;
}

async function fetchJson(url){
  const r = await fetch(url, {cache:'no-store'});
  const t = await r.text();
  try { return JSON.parse(t); } catch { return {}; }
}
async function getFeed(){
  const urls = [
    `${JINA}/http://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=50&orderby=published`,
    `${JINA}/https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=50&orderby=published`,
    `${ALLO}?url=${encodeURIComponent(FEED)}`,
    FEED
  ];
  for(const u of urls){
    try{
      const d = await fetchJson(u);
      if(d?.feed?.entry?.length) return d;
    }catch{}
  }
  throw new Error("no feed");
}

function parseEntries(data){
  const entries = data?.feed?.entry||[];
  return entries.map(e=>{
    const rawHtml = e.summary?.$t || e.content?.$t || "";
    const textOnly = rawHtml.replace(/<[^>]+>/g, " ").replace(/\s+/g,' ').trim();
    const title = (e.title?.$t||"").trim() || textOnly.split(/\s+/).slice(0,12).join(" ")+"â€¦";
    const link = (e.link||[]).find(l=>l.rel==='alternate')?.href || "#";
    const date = e.published?.$t || e.updated?.$t || new Date().toISOString();
    const id = (e.id?.$t||"").split("post-").pop() || "";
    const thumbRaw = e['media$thumbnail']?.url || (rawHtml.match(/<img[^>]+src=["']([^"']+)["']/i)?.[1]) || DEFAULT_NEWS_IMAGE;
    const image = upsizeBloggerImage(thumbRaw, 1200);
    const contentHtml = (e.content?.$t || e.summary?.$t || "").replace(/src=["']([^"']+)["']/g,(m,p)=>`src="${upsizeBloggerImage(p,1200)}"`);
    return {id,title,link,date,image,summary:textOnly,html:contentHtml};
  });
}

function renderList(items){
  const wrap = document.createElement('div');
  wrap.className = "grid cols-3";
  wrap.innerHTML = items.map(n => `
    <article class="card">
      <a class="news-thumb" href="news.html?id=${encodeURIComponent(n.id)}">${imgTagHD(n.image, n.title).replace('article-hero','')}</a>
      <div class="pad">
        <div class="muted">${new Date(n.date).toLocaleDateString()}</div>
        <h3 style="margin:6px 0">${n.title}</h3>
        <p class="muted" style="margin:8px 0">${n.summary}</p>
        <div class="actions">
          <a class="btn brand" href="news.html?id=${encodeURIComponent(n.id)}">ðŸ“° Leer</a>
          <button class="btn btn-share" data-id="${n.id}" data-title="${n.title}">ðŸ”— Compartir</button>
        </div>
      </div>
    </article>
  `).join("");
  $("#view").innerHTML = "";
  $("#view").appendChild(wrap);

  wrap.addEventListener('click', async (e)=>{
    const b = e.target.closest('.btn-share'); if(!b) return;
    const url = new URL(location.href); url.search = ""; url.searchParams.set("id", b.dataset.id);
    try{
      if(navigator.share){ await navigator.share({title:b.dataset.title, url:url.toString()}); }
      else { await navigator.clipboard.writeText(url.toString()); b.textContent = "âœ… Copiado"; setTimeout(()=>b.textContent="ðŸ”— Compartir",1500); }
    }catch{}
  });
}

function renderArticle(n){
  const v = $("#view");
  v.innerHTML = `
    <article class="article">
      <h2>${n.title}</h2>
      <div class="muted">${new Date(n.date).toLocaleString()}</div>
      ${imgTagHD(n.image, n.title)}
      <div class="card pad" id="content">${n.html}</div>
      <div class="actions">
        <a class="btn" href="index.html#news">â¬… Volver</a>
        <button class="btn" id="sh">ðŸ”— Compartir</button>
        <a class="btn brand" href="${n.link}" target="_blank" rel="noopener">Abrir en Blogger</a>
      </div>
    </article>
  `;
  document.getElementById('sh').addEventListener('click', async ()=>{
    try{
      if(navigator.share){ await navigator.share({title:n.title, url:location.href}); }
      else { await navigator.clipboard.writeText(location.href); document.getElementById('sh').textContent="âœ… Copiado"; setTimeout(()=>document.getElementById('sh').textContent="ðŸ”— Compartir",1500); }
    }catch{}
  });

  // JSON-LD Article
  const ld = {
    "@context":"https://schema.org","@type":"NewsArticle",
    "headline": n.title, "datePublished": n.date, "image":[n.image],
    "mainEntityOfPage":{"@type":"WebPage","@id":location.href},
    "author":{"@type":"Organization","name":"El Portal Gamer"},
    "publisher":{"@type":"Organization","name":"El Portal Gamer"}
  };
  let s=document.getElementById("ld-news"); if(s) s.remove();
  s=document.createElement("script"); s.type="application/ld+json"; s.id="ld-news"; s.textContent=JSON.stringify(ld);
  document.head.appendChild(s);
}

(async function init(){
  const id = new URL(location.href).searchParams.get("id");

  const data = await getFeed();
  const items = parseEntries(data);

  if(id){
    const hit = items.find(x=>x.id===id);
    if(hit) renderArticle(hit);
    else renderList(items.slice(0,9));
  }else{
    renderList(items.slice(0,9));
  }

  // Buscador simple
  $("#q").addEventListener('input', e=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q) return renderList(items.slice(0,9));
    const res = items.filter(n => (n.title+" "+n.summary).toLowerCase().includes(q)).slice(0,18);
    renderList(res);
  });
})();
</script>
</body>
</html>
