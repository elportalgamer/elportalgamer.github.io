<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Portal Gamer — Reseñas y retro</title>

  <link rel="canonical" href="https://www.elportalgamer.com/" />
  <link rel="icon" type="image/png" href="mago.png" />

  <meta name="description" content="Reseñas sinceras, retro y rarezas: PS1, PS2, Dreamcast, JRPG y survival horror. Videos y reseñas en El Portal Gamer." />
  <meta property="og:title" content="El Portal Gamer — Reseñas y retro" />
  <meta property="og:description" content="Reseñas sinceras, retro y rarezas: PS1, PS2, Dreamcast, JRPG y survival horror." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.elportalgamer.com/" />
  <meta property="og:image" content="https://www.elportalgamer.com/og.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="El Portal Gamer — Reseñas y retro" />
  <meta name="twitter:description" content="Reseñas sinceras, retro y rarezas: PS1, PS2, Dreamcast, JRPG y survival horror." />
  <meta name="twitter:image" content="https://www.elportalgamer.com/og.jpg" />

  <style>
    :root{ --bg:#121212; --surface:#1f1f1f; --text:#f0f0f0; --muted:#b5b5b5; --brand:#ff4500; --card:#171717; --radius:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:#161616;border-bottom:1px solid #242424}
    .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:1.25rem;color:var(--brand)}
    .brand img{height:34px;border-radius:6px}
    .nav a{color:#eaeaea;text-decoration:none;opacity:.9;padding:6px 8px;border-radius:10px}
    .nav a:hover{opacity:1;background:#1d1d1d}
    .spacer{flex:1}
    .search{display:flex;align-items:center;gap:8px;background:#1b1b1b;border:1px solid #2a2a2a;padding:6px 10px;border-radius:12px}
    .search input{background:transparent;border:0;outline:0;color:#eaeaea;min-width:200px}

    main{max-width:1100px;margin:20px auto;padding:0 16px}
    h2{margin:16px 0 10px;font-size:1.35rem}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card,.n-card{background:var(--card);border:1px solid #262626;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
    .pad{padding:14px}
    .videobox{position:relative;aspect-ratio:16/9;background:#0e0e0e;border-radius:12px;overflow:hidden}

    .lite-yt{position:relative;width:100%;height:100%;background-size:cover;background-position:center;cursor:pointer}
    .lty-playbtn{position:absolute;inset:0;margin:auto;width:68px;height:48px;border:0;background:transparent;filter:drop-shadow(2px 2px 2px rgba(0,0,0,.4));cursor:pointer}
    .lty-playbtn svg{display:block;width:100%;height:100%}

    .news-thumb{display:block;aspect-ratio:16/9;background:#0e0e0e}
    .news-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .n-content{padding:14px}
    .n-content .title{font-weight:800;margin-bottom:6px}
    .n-content .desc{color:var(--muted);line-height:1.45}
    .news-meta{display:flex;align-items:center;gap:10px;color:#d0d0d0;font-size:.9rem;margin-bottom:10px}
    .badge{background:#2a2a2a;color:#f3f3f3;padding:3px 8px;border-radius:20px;font-size:.8rem}

    .btn{display:inline-block;padding:10px 18px;border-radius:12px;border:1px solid #2c2c2c;background:#1c1c1c;color:#fff;text-decoration:none}
    .btn.brand{background:var(--brand);border-color:#e33c00;color:#000;font-weight:900}
    .btn.black{background:#101010}

    .muted{color:#bdbdbd}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:900px){.cards{grid-template-columns:1fr}}

    .footer{max-width:1100px;margin:20px auto 40px;padding:0 16px;color:#bdbdbd}
    .footer a{color:#e0e0e0}

    /* Compartir popover */
    #share-pop{position:fixed;right:16px;bottom:16px;background:#1b1b1b;border:1px solid #2a2a2a;border-radius:14px;padding:10px 12px;display:none;gap:8px}
    #share-pop.show{display:flex}
    #share-pop a,#share-pop .btn{font-size:.9rem}
  </style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="brand" href="/"><img src="mago.png" alt="logo" />El Portal Gamer</a>
    <a href="#ultimo">Último video</a>
    <a href="#news">Noticias</a>
    <a href="#reviews">Reseñas</a>
    <a href="#series">Series</a>
    <span class="spacer"></span>
    <div class="search"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3" stroke="#aaa" stroke-width="2" stroke-linecap="round"/><circle cx="10" cy="10" r="7" stroke="#aaa" stroke-width="2"/></svg><input id="q" placeholder="Buscar"/></div>
  </nav>
</header>

<main>
  <section id="ultimo">
    <h2>Último video</h2>
    <div class="card pad">
      <div id="ultimo-lite" class="videobox"></div>
      <div style="padding-top:10px">
        <div id="ultimo-titulo" class="title"></div>
        <div class="muted" id="ultimo-fecha"></div>
        <p id="ultimo-desc" class="desc"></p>
        <a id="ultimo-ver" class="btn brand" href="#" target="_blank" rel="noopener">Ver en YouTube</a>
      </div>
    </div>
  </section>

  <section id="news" style="margin-top:26px">
    <h2>Noticias</h2>
    <div id="news-grid" class="grid"></div>
  </section>

  <section id="reviews" style="margin-top:26px">
    <h2>Reseñas</h2>
    <div class="cards" id="rev-cards"></div>
  </section>

  <section id="series" style="margin-top:26px">
    <h2>Series</h2>
    <div class="cards" id="series-cards"></div>
  </section>

  <section id="support" style="margin-top:26px">
    <h2>Apóyanos</h2>
    <div class="card pad">
      <p>Si te gusta el contenido, podés apoyar el proyecto en Ko‑fi o usando nuestros enlaces de afiliado.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn brand" href="https://ko-fi.com/" target="_blank" rel="noopener">Ko‑fi</a>
        <a class="btn" href="#" target="_blank" rel="noopener">Instant-Gaming</a>
        <a class="btn" href="#" target="_blank" rel="noopener">Amazon</a>
      </div>
    </div>
  </section>

  <section id="contact" style="margin-top:26px">
    <h2>Contacto</h2>
    <form id="contact-form" class="card pad" action="https://formspree.io/f/xxxxxxx" method="POST">
      <input type="text" name="name" placeholder="Tu nombre" required style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#171717;color:#eaeaea"/>
      <input type="email" name="email" placeholder="Tu email" required style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#171717;color:#eaeaea"/>
      <textarea name="message" placeholder="Mensaje" required rows="4" style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#171717;color:#eaeaea"></textarea>
      <button class="btn brand" type="submit">Enviar</button>
      <span id="form-result" class="muted" style="margin-left:8px"></span>
    </form>
  </section>
</main>

<div id="share-pop"></div>

<script defer>
/* ====== Config ====== */
const API_KEY="AIzaSyCqPlM0Ab3-_mtFHPmrrgJTS1S4dBCbbMA";
const PLAYLIST_ID="PLk3cei5OOiyvTQzg5FGgIRY3xs44F7Wzv";
const MAX_RESULTS=20;

const BLOGGER_FEED_HTTPS="https://portalgamerok.blogspot.com/feeds/posts/summary?alt=json&max-results=6&orderby=published";
const JINA="https://r.jina.ai";
const ALLO="https://api.allorigins.win/raw";

const $=(s,p=document)=>p.querySelector(s);
const $$=(s,p=document)=>[...p.querySelectorAll(s)];
const truncate=(str,n)=> (str||"").length>n ? str.slice(0,n).replace(/\s+\S*$/,'')+"…" : str;
const words=(x)=>(x||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,'').toLowerCase();

/* ===== Anti-pixelado Blogger (mejorado + https) ===== */
function bloggerToOriginal(u){
  if(!u) return '';
  try{
    if(u.startsWith('//')) u = 'https:' + u;
    if(u.startsWith('http://')) u = 'https://' + u.slice(7);
    u = u
      .replace(/\/s\d+[^/]*\//,'/s1600/')
      .replace(/=s\d+[^&?]*/,'=s1600')
      .replace(/w\d+-h\d+-p-k-no/i,'s1600');
    return u;
  }catch{ return u; }
}
function bloggerFromOriginalSet(u,size){
  if(!u) return '';
  try{
    let s = String(size||1200);
    return u.replace(/\/s\d+[^/]*\//, '/s'+s+'/').replace(/=s\d+[^&?]*/, '=s'+s);
  }catch{ return u; }
}
/* Normalizador https para cualquier imagen externa */
function normalizeImg(u){
  if(!u) return '';
  try{
    if(u.startsWith('//')) return 'https:' + u;
    if(u.startsWith('http://')){
      const host = new URL(u).hostname;
      if(/(blogger|blogspot|googleusercontent|ggpht)/i.test(host)){
        return 'https://' + u.slice(7);
      }
      const bare = u.replace(/^https?:\/\//,'');
      return `https://images.weserv.nl/?url=${encodeURIComponent(bare)}`;
    }
    return u;
  }catch{ return u; }
}

/* ---------- Imagen desde HTML (mejorada) ---------- */
function pickFromSrcset(srcset){
  if(!srcset) return "";
  const parts = srcset.split(',').map(s=>s.trim());
  let best = "", w = 0;
  for(const p of parts){
    const [url, desc] = p.split(/\s+/);
    const m = /(\d+)w/.exec(desc||"");
    const val = m ? parseInt(m[1],10) : 0;
    if(val >= w){ w = val; best = url; }
  }
  return best || parts[parts.length-1].split(/\s+/)[0];
}
function extractImgFromHtml(html){
  try{
    const doc = new DOMParser().parseFromString(html||"", "text/html");
    const img = doc.querySelector('img');
    if(!img) return "";
    const s = img.getAttribute('src') || img.getAttribute('data-src') || img.getAttribute('data-original') || img.getAttribute('data-actualsrc') || "";
    const ss= img.getAttribute('srcset');
    return s || pickFromSrcset(ss);
  }catch{ return ""; }
}
/* Filtro de placeholders */
function isPlaceholder(u){
  if(!u) return true;
  if(u.startsWith('data:')) return true;
  if(/blank\.gif|transparent|spacer/i.test(u)) return true;
  return false;
}

/* ---------- OG image real ---------- */
async function fetchOgImageViaProxy(url){
  try{
    const prox = `${JINA}/${url}`;
    const html = await (await fetch(prox, {cache:'no-store'})).text();
    const doc  = new DOMParser().parseFromString(html, "text/html");
    const og = doc.querySelector('meta[property="og:image"],meta[name="og:image"],meta[property="og:image:url"],meta[name="twitter:image"],meta[name="twitter:image:src"]');
    return og?.content || "";
  }catch{ return ""; }
}

/* ===== YouTube ===== */
function renderUltimo(v){
  const box=$("#ultimo-lite"); box.className="videobox";
  const lite=document.createElement("div");
  lite.className="lite-yt"; lite.style.backgroundImage=`url(${v.thumb})`;
  lite.innerHTML=`<button class="lty-playbtn" aria-label="Reproducir ${v.title}">
    <svg viewBox="0 0 68 48"><path d="M66.52 7.02a8 8 0 0 0-5.64  ...  M27 34V14l18 10-18 10z"/></svg>
  </button>`;
  lite.addEventListener("click",()=>{ box.innerHTML=`<iframe src="https://www.youtube.com/embed/${v.id}?autoplay=1" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen title="${v.title}"></iframe>`;});
  box.appendChild(lite);
  $("#ultimo-titulo").textContent=v.title;
  $("#ultimo-fecha").textContent=new Date(v.date).toLocaleDateString();
  $("#ultimo-desc").textContent=truncate(v.desc,420);
  $("#ultimo-ver").href=`https://www.youtube.com/watch?v=${v.id}`;
}

/* ===== Noticias ===== */
function timeAgo(d){ const n=new Date(d), now=new Date(); const diff=Math.max(0,(now.getTime()-n.getTime())/1000); const u=[[31536000,'a'],[2592000,'m'],[604800,'sem'],[86400,'d'],[3600,'h'],[60,'min']]; for(const [s,nm] of u){ if(diff>=s) return `${Math.floor(diff/s)} ${nm}`;} return 'ahora'; }
function extractFirstImgOrFallback(rawHtml){ const u = extractImgFromHtml(rawHtml); return isPlaceholder(u) ? "" : u; }
function newsHref(n){ const base=new URL('news.html', location.origin); if(n.id) base.searchParams.set('id', n.id); else if(n.url) base.searchParams.set('u', n.url); return base.toString(); }

function parseBloggerJson(data){
  const entries=data?.feed?.entry||[];
  return entries.map(e=>{
    const raw=e.summary?.$t||e.content?.$t||"";
    const text=raw.replace(/<[^>]+>/g," ").replace(/\s+/g,' ').trim();
    const title=(e.title?.$t||"").trim() || (text?text.split(/\s+/).slice(0,12).join(" ")+"…":"Sin título");
    const link=(e.link||[]).find(l=>l.rel==='alternate')?.href || '';
    const date=e.published?.$t || e.updated?.$t || new Date().toISOString();
    const firstInPost = extractFirstImgOrFallback(raw);
    const thumbMeta   = e['media$thumbnail']?.url || '';
    const chosen      = firstInPost || thumbMeta;
    const s0=bloggerToOriginal(chosen);
    const id=(e.id?.$t||"").split("post-").pop();
    return { title, url:link, date, summary:text, image0:s0, id };
  });
}

/* Completa imágenes faltantes usando OG de la página real */
async function resolveMissingImages(items){
  for(const it of items){
    if(!it.image0 || isPlaceholder(it.image0)){
      const og = await fetchOgImageViaProxy(it.url);
      if(og){ it.image0 = bloggerToOriginal(og) || og; }
    }
  }
  return items;
}

function renderNews(items){
  const grid=$("#news-grid"); grid.innerHTML="";
  items.forEach(n=>{
    const href=newsHref(n);
    const v600   = normalizeImg(bloggerFromOriginalSet(n.image0,600));
    const v800   = normalizeImg(bloggerFromOriginalSet(n.image0,800));
    const v1200  = normalizeImg(bloggerFromOriginalSet(n.image0,1200));
    const v1600  = normalizeImg(bloggerFromOriginalSet(n.image0,1600));
    const base   = normalizeImg(v1200 || v800 || v600 || n.image0) || '/og.jpg';

    const parts=[]; if(v600)parts.push(`${v600} 600w`); if(v800)parts.push(`${v800} 800w`); if(v1200)parts.push(`${v1200} 1200w`); if(v1600)parts.push(`${v1600} 1600w`);
    const srcset = parts.join(', ');

    const card=document.createElement('article');
    card.className="n-card filterable"; card.dataset.title=n.title; card.dataset.desc=n.summary;

    card.innerHTML=`
      <a class="news-thumb" data-nav="news" href="${href}" aria-label="${n.title}">
        <img loading="lazy" decoding="async"
             src="${base}"
             ${srcset ? `srcset="${srcset}"` : ''}
             sizes="(min-width:1200px) 30vw, (min-width:900px) 45vw, 92vw"
             alt="">
      </a>
      <div class="n-content">
        <div class="news-meta"><span class="badge">Noticia</span><span>${timeAgo(n.date)}</span></div>
        <div class="title">${n.title}</div>
        <p class="desc">${truncate(n.summary,220)}</p>
        <div class="n-actions">
          <a class="btn brand" data-nav="news" href="${href}">Leer</a>
          <button class="btn black share-btn" type="button" data-url="${href}" data-title="${n.title}">Compartir</button>
        </div>
      </div>`;

    const img = card.querySelector('img');
    if(img){
      img.addEventListener('error', async ()=>{
        try{
          img.removeAttribute('srcset');
          const og = await fetchOgImageViaProxy(n.url);
          const fixed = normalizeImg(bloggerFromOriginalSet(bloggerToOriginal(og),1200));
          img.src = fixed || '/og.jpg';
        }catch{ img.src = '/og.jpg'; }
      }, { once:true });
    }

    grid.appendChild(card);
  });

  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-nav="news"]');
    if(a){ e.preventDefault(); window.location.href = a.href; }
  }, {passive:false});

  const pop=$("#share-pop");
  function showPop(url,title){
    const u=encodeURIComponent(url), t=encodeURIComponent(title);
    pop.innerHTML = `
      <a target="_blank" rel="noopener" href="https://wa.me/?text=${t}%20${u}">WhatsApp</a>
      <a target="_blank" rel="noopener" href="https://t.me/share/url?url=${u}&text=${t}">Telegram</a>
      <a target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?url=${u}&text=${t}">X/Twitter</a>
      <a target="_blank" rel="noopener" href="https://www.facebook.com/sharer/sharer.php?u=${u}">Facebook</a>
      <button id="copyLink" class="btn">Copiar enlace</button>
      <button id="closeShare" class="btn">Cerrar</button>
    `;
    pop.classList.add('show');
    $("#copyLink",pop).onclick=async()=>{ await navigator.clipboard.writeText(url); $("#copyLink",pop).textContent="Copiado ✅"; };
    $("#closeShare",pop).onclick=()=>pop.classList.remove('show');
  }
  document.addEventListener('click',e=>{ const btn=e.target.closest('.share-btn'); if(btn){ showPop(btn.dataset.url, btn.dataset.title); } });
}

/* ===== Carga YouTube ===== */
async function fetchPlaylist(){
  const u=`https://www.googleapis.com/youtube/v3/playlistItems?key=${API_KEY}&playlistId=${PLAYLIST_ID}&part=snippet,contentDetails&maxResults=${MAX_RESULTS}`;
  const d=await (await fetch(u)).json();
  const items=(d.items||[]).map(i=>({
    id:i.contentDetails?.videoId,
    title:i.snippet?.title||"",
    desc:i.snippet?.description||"",
    date:i.contentDetails?.videoPublishedAt||i.snippet?.publishedAt,
    thumb:i.snippet?.thumbnails?.maxres?.url||i.snippet?.thumbnails?.standard?.url||i.snippet?.thumbnails?.high?.url||""
  })).filter(v=>v.id);
  return items;
}
async function loadPlaylist(){
  try{
    const vids=await fetchPlaylist();
    if(!vids.length) return;
    renderUltimo(vids[0]);
  }catch(e){ console.error(e); }
}

/* ===== Carga Noticias ===== */
async function fetchJson(u){ return await (await fetch(u,{cache:'no-store'})).json(); }
async function getBloggerData(){
  const urls = [ `${ALLO}?url=${encodeURIComponent(BLOGGER_FEED_HTTPS)}`, BLOGGER_FEED_HTTPS ];
  for(const u of urls){ try{ const d=await fetchJson(u); if(d?.feed?.entry?.length) return d; }catch{} }
  throw new Error("No se pudo obtener el feed");
}
async function loadNews(){
  try{
    const data=await getBloggerData();
    let items=parseBloggerJson(data);
    items = await resolveMissingImages(items);
    if(!items.length) throw new Error("Sin entradas");
    renderNews(items);
  }catch(e){
    try{
      const res=await fetch('/news.json',{cache:'no-store'}); let items=await res.json();
      items=(items||[]).map(n=>({ ...n, image0:bloggerToOriginal(n.image), id:n.id }));
      items = await resolveMissingImages(items);
      if(items.length) renderNews(items); else throw new Error('news.json vacío');
    }catch{ $("#news-grid").innerHTML=`<div class="muted">No se pudieron cargar las noticias.</div>`; }
  }
}

/* ===== Datos estáticos reseñas/series (placeholder) ===== */
(function(){
  const rev=[
    {title:"Clock Tower 3 (PS2)",desc:"Survival horror distinto, con diseño tenso y ambientación gótica.",img:"/og.jpg"},
    {title:"Shadow Hearts (PS2)",desc:"RPG oscuro con Anillo del Juicio y aura lovecraftiana.",img:"/og.jpg"},
    {title:"Parasite Eve (PS1)",desc:"Square en modo bio‑horror cinematográfico.",img:"/og.jpg"}
  ];
  const rbox=$("#rev-cards"); rev.forEach(x=>{ const el=document.createElement('div'); el.className='card pad'; el.innerHTML=`<div class="videobox" style="background-image:url(${x.img});background-size:cover"></div><h3>${x.title}</h3><p class="muted">${x.desc}</p>`; rbox.appendChild(el); });

  const ser=[
    {title:"Saga Parasite Eve",desc:"Análisis de la saga.",img:"/og.jpg"},
    {title:"Survival Horror PS1/PS2",desc:"Selección curada.",img:"/og.jpg"},
    {title:"JRPG & Square",desc:"JRPGs y rarezas de Square.",img:"/og.jpg"}
  ];
  const sbox=$("#series-cards"); ser.forEach(x=>{ const el=document.createElement('div'); el.className='card pad'; el.innerHTML=`<div class="videobox" style="background-image:url(${x.img});background-size:cover"></div><h3>${x.title}</h3><p class="muted">${x.desc}</p>`; sbox.appendChild(el); });

  // Búsqueda simple en tarjetas
  const input=$("#q"); input?.addEventListener('input',()=>{
    const q=words(input.value);
    $$('.filterable').forEach(el=>{
      const t=words(el.dataset.title||'');
      const d=words(el.dataset.desc||'');
      el.style.display = (t.includes(q) || d.includes(q)) ? '' : 'none';
    });
  });

  // Formspree
  const form=$("#contact-form"), result=$("#form-result");
  form?.addEventListener('submit',async(e)=>{
    e.preventDefault(); result.textContent='Enviando…';
    try{ const r=await fetch(form.action,{method:'POST',body:new FormData(form),headers:{'Accept':'application/json'}});
      if(r.ok){ result.textContent='¡Mensaje enviado!'; form.reset();}
      else{ result.textContent='Hubo un error al enviar.';}
    }catch{ result.textContent='No se pudo enviar. Probá más tarde.';}
  });
})();

/* ===== Init ===== */
loadPlaylist();
loadNews();
</script>
</body>
</html>
